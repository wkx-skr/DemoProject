<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>忘记密码</title>
    <script src="./static/js/jquery.min.js"></script>
    <script src="./static/js/jsencrypt2.min.js"></script>
    <script src="./static/js/pubkey.js"></script>
<!--    <script src="./static/conf/setting.js"></script>-->
    <script>
        document.write("<script src='./static/conf/setting.js?"+Math.random()+"'><\/script>");
    </script>
</head>
<body style="background-color:lightgray;">
<div style="background-color:#FFF;width:400px;height:190px;border-radius:4px;margin:100px auto;padding-left:20px;">
    <br>
    <label for="input-password">请输入新密码</label>
    <input id="input-password" type="password"><br><br>
    <label for="repeat-password">再次输入密码</label>
    <input id="repeat-password" type="password"><br><br>
    <input type="button" id="confirm" value="确定" style="margin-left:101px;" onclick="handleConfirm()" />
</div>
<script>
    var j = window.setting
    pathname = j.restApiPathName
    function postPassword(enc){
        let uniqueId = location.search;
        if(!uniqueId || !uniqueId.includes('id=')){
            alert('重置密码的链接已被破坏，请重新从邮件中访问链接');
            return;
        }else{
            uniqueId = location.search.split('id=')[1];
        }
        $.ajax({
            type: "post",
            url: pathname + "/service/reset_password/" + uniqueId,
            async: true,
            contentType:'plain/text',
            data:enc,
            success: function (data) {
                alert('密码已成功重置');
            },
            error:function(e){
                console.error(e)
                if (e.responseJSON && e.responseJSON.errorMessage) {
                    alert(e.responseJSON.errorMessage);
                }
            }
        });
    }
    function encodePassword(){
        var crypt = new JSEncrypt({ default_key_size: 2048 });
        crypt.setPublicKey(pubkey);
        var text = document.getElementById('input-password').value;
        var enc = crypt.encrypt(text);
        postPassword(enc);
    }
    function handleConfirm(){
        let val1 = $('#input-password').val();
        let val2 = $('#repeat-password').val();
        if(!val1){
            alert('请填写密码');
        }else if(!val2){
            alert('请再次填写密码');
        }else if(val1 !== val2 ){
            alert('两次填写的密码不同，请重新填写');
        }else{
            encodePassword();
        }
    }

</script>
</body>
</html>
